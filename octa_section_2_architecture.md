---
title: Раздел 2. Архитектура системы
order: 1.9
---

# Раздел 2. Архитектура системы

## 2.1 Общая архитектура

### 2.1.1 Компонентная модель

```
┌─────────────────────────────────────────────┐
│            Облако OCTA                      │
│  ┌─────────────────────────────────────┐    │
│  │  База данных конфигураций стендов   │    │
│  └─────────────────────────────────────┘    │
│  ┌─────────────────────────────────────┐    │
│  │   Web-интерфейс управления          │    │
│  └─────────────────────────────────────┘    │
│  ┌─────────────────────────────────────┐    │
│  │      WebSocket Server               │    │
│  └──────────┬──────────┬───────────────┘    │
└─────────────┼──────────┼────────────────────┘
              │          │
         Internet   Internet
              │          │
    ┌─────────▼──────────▼─────────┐
    │      Испытательный стенд     │
    │                              │
    │  ┌──────────────────────┐   │
    │  │   Core (ESP32-P4)    │◄──┼── Физические кнопки
    │  │   Token: XXX-Core    │   │   - Принять
    │  └──────┬──────┬────────┘   │   - Повтор
    │         │      │             │
    │    Local│      │Local        │
    │         │      │             │
    │  ┌──────▼──┐ ┌─▼──────────┐ │
    │  │Terminal │ │  Display   │ │
    │  │  (HMI)  │ │   (TV)     │ │
    │  │Token:   │ │Token:      │ │
    │  │XXX-HMI  │ │XXX-TV      │ │
    │  └────┬────┘ └────────────┘ │
    │       │                      │
    │    ┌──▼─────────────┐       │
    │    │ BT устройства: │       │
    │    │ - Штангенциркуль│      │
    │    │ - Микрометр    │       │
    │    └────────────────┘       │
    └──────────────────────────────┘
```

### 2.1.2 Распределение функций

| Компонент | Основные функции | Ответственность |
|-----------|------------------|-----------------|
| **Облако** | • Хранение конфигураций<br>• Управление шагами<br>• Агрегация данных<br>• Web-интерфейс | Центральное управление |
| **Core** | • Загрузка конфигуратора<br>• Распределение команд<br>• Управление оборудованием<br>• Обработка физических кнопок | Исполнительное ядро |
| **Terminal** | • Сбор BT-данных<br>• Интерфейс оператора<br>• Фотофиксация<br>• Локальное хранение | Взаимодействие с оператором |
| **Display** | • Отображение инструкций<br>• Визуализация данных<br>• Показ результатов | Информирование |

## 2.2 Последовательность инициализации

### 2.2.1 Алгоритм старта стенда

```python
# Pseudocode: Инициализация стенда
def stand_initialization():
    # 1. Core включается
    core.power_on()
    
    # 2. Проверка интернет-соединения
    if not core.check_internet():
        core.enter_offline_mode()
        return
    
    # 3. Загрузка конфигуратора (Шаг 0)
    stand_token = core.read_token()  # 36-разрядный UUID
    config_url = f"https://octa.cloud/api/stands/{stand_token}/config"
    configurator = core.download_config(config_url)
    
    # 4. Применение конфигурации
    core.apply_configuration(configurator)
    
    # 5. Установка WebSocket соединений
    core_ws = connect_websocket(f"wss://octa.cloud/ws/{stand_token}-Core")
    terminal_ws = connect_websocket(f"wss://octa.cloud/ws/{stand_token}-HMI")
    display_ws = connect_websocket(f"wss://octa.cloud/ws/{stand_token}-TV")
    
    # 6. Запуск heartbeat
    start_heartbeat_timer(interval=5000)  # каждые 5 секунд
    
    # 7. Готовность к работе
    core.set_state(READY)
    core.send_status("online", "все хорошо")
```

### 2.2.2 Временная диаграмма старта

| Время | Событие | Описание |
|-------|---------|----------|
| T+0s | Power ON | Включение питания Core |
| T+1s | Network check | Проверка интернет-соединения |
| T+2s | Download config | Загрузка конфигуратора |
| T+3s | Apply config | Применение конфигурации |
| T+4s | WSS connect | Установка WebSocket соединений |
| T+5s | First heartbeat | Первое сообщение состояния |
| T+6s | READY state | Готовность к работе |

## 2.3 Токены и идентификация

### 2.3.1 Структура токенов

```
Stand Token (36 символов UUID):
550e8400-e29b-41d4-a716-446655440000

Device Tokens:
Core:     550e8400-e29b-41d4-a716-446655440000-Core
Terminal: 550e8400-e29b-41d4-a716-446655440000-HMI
Display:  550e8400-e29b-41d4-a716-446655440000-TV
```

### 2.3.2 Использование токенов

- **При загрузке конфигурации**: `/api/stands/{stand_token}/config`
- **При WebSocket подключении**: `/ws/{device_token}`
- **В сообщениях**: Поле `stand_token` или `device_token`

## 2.4 Каналы связи

### 2.4.1 Внешние каналы (Облако ↔ Стенд)

| Канал | Протокол | Направление | Использование |
|-------|----------|-------------|---------------|
| Config API | HTTPS | Облако → Core | Загрузка конфигурации |
| WebSocket | WSS | Двунаправленный | Команды и телеметрия |
| Heartbeat | WSS | Core → Облако | Состояние "онлайн" |

### 2.4.2 Внутренние каналы (внутри стенда)

| Канал | Тип связи | Направление | Данные |
|-------|-----------|-------------|--------|
| Core ↔ Terminal | Local network | Двунаправленный | Команды, BT-данные |
| Core ↔ Display | Local network | Core → Display | Визуализация |
| Terminal ↔ BT | Bluetooth | BT → Terminal | Измерения |
| Buttons → Core | GPIO | Односторонний | Сигналы кнопок |

## 2.5 Маршрутизация команд

### 2.5.1 Принцип маршрутизации

> "Все команды, которые потом приходят в ядро, ядром же уже и распределяются"

```python
# Core распределяет команды
def core_route_command(command):
    if command.target == "core":
        execute_locally(command)
    elif command.target == "terminal":
        forward_to_terminal(command)
    elif command.target == "display":
        forward_to_display(command)
```

### 2.5.2 Структура команды с маршрутами

```json
{
  "type": "command",
  "command_id": "step-10-measure",
  "routes": [
    {
      "device": "core",
      "payload": {
        "action": "valve_config",
        "preset": "pressure_test"
      }
    },
    {
      "device": "terminal",
      "payload": {
        "action": "collect_bt_data",
        "device": "caliper"
      }
    },
    {
      "device": "display",
      "payload": {
        "action": "show_measurement",
        "title": "Измерение давления"
      }
    }
  ]
}
```

## 2.6 Управление состоянием

### 2.6.1 Состояния системы

```
┌──────────────┐
│ INITIALIZING │ - Загрузка конфигурации
└──────┬───────┘
       ▼
┌──────────────┐
│     IDLE     │ - Ожидание оператора
└──────┬───────┘
       ▼
┌──────────────┐
│  IDENTIFIED  │ - Оператор идентифицирован
└──────┬───────┘
       ▼
┌──────────────┐
│   TESTING    │ - Выполнение диагностики
└──────┬───────┘
       ▼
┌──────────────┐
│  EMERGENCY   │ - Аварийный режим (при потере связи)
└──────────────┘
```

### 2.6.2 Heartbeat механизм

```json
{
  "type": "heartbeat",
  "stand_token": "550e8400-e29b-41d4-a716-446655440000",
  "device": "core",
  "timestamp": 1695805200000,
  "status": "online",
  "message": "все хорошо",
  "state": "IDLE",
  "modules": {
    "core": "ok",
    "terminal": "ok",
    "display": "ok"
  }
}
```

## 2.7 Обработка физических кнопок

### 2.7.1 Алгоритм обработки

```python
def handle_physical_button(button_type):
    if button_type == "ACCEPT":
        # Проверка 5-секундного барьера
        if time_since_start() < 5000:
            send_error("Слишком рано для подтверждения")
            return
        
        # Сбор всех данных
        data = {
            "core_measurements": get_core_data(),
            "terminal_data": get_terminal_data(),
            "timestamp": current_time()
        }
        
        # Отправка в облако
        send_to_cloud(data)
        
    elif button_type == "RETRY":
        # Сброс текущих измерений
        reset_measurements()
        
        # Уведомление Terminal о повторе
        notify_terminal("retry")
        
        # Возврат в начальное состояние шага
        restart_current_step()
```

### 2.7.2 Защитный барьер

- **5-секундный минимум**: Кнопка "Принять" активна только после 5 секунд
- **Визуальная индикация**: LED или звуковой сигнал готовности
- **Защита от дребезга**: Debounce 50ms

## 2.8 Аварийные режимы

### 2.8.1 Триггеры аварийного режима

1. **Потеря связи с облаком** (> 30 секунд)
2. **Потеря связи с модулем** (Terminal или Display)
3. **Критическая ошибка оборудования**
4. **Ручная активация** (аварийная кнопка)

### 2.8.2 Действия в аварийном режиме

Из конфигуратора загружается preset "emergency":

```json
{
  "emergency_preset": {
    "valves": "all_closed",
    "pressure": "release",
    "power_blocks": "off",
    "devices": "shutdown",
    "notification": "local_alarm"
  }
}
```

## 2.9 Распределение данных

### 2.9.1 Источники данных

| Источник | Тип данных | Маршрут | Обработка |
|----------|------------|---------|-----------|
| BT-устройства | Измерения | BT → Terminal → Core → Cloud | Передаются "сырыми" |
| Датчики Core | Давление, температура | Core → Cloud | С калибровкой |
| Физические кнопки | События | Buttons → Core → Cloud | Мгновенно |
| Камера Terminal | Фото | Terminal → Cloud | Сжатие JPEG |

### 2.9.2 Хранение промежуточных данных

- **Terminal**: Держит BT-измерения до нажатия физической кнопки
- **Core**: Буферизует телеметрию при потере связи
- **Display**: Не хранит данные, только отображает

## 2.10 Отказоустойчивость

### 2.10.1 Сценарии отказов

| Отказ | Детекция | Реакция |
|-------|----------|---------|
| Потеря интернета | Heartbeat timeout | Аварийный режим |
| Отказ Terminal | No response 5s | Уведомление в облако, продолжение без BT |
| Отказ Display | No response 5s | Уведомление в облако, продолжение "вслепую" |
| Отказ BT-устройства | Connection lost | Запрос ручного ввода |

### 2.10.2 Восстановление

- **Автоматическое переподключение** при восстановлении связи
- **Синхронизация состояния** с облаком
- **Отправка накопленных данных** из буфера

---

*Конец Раздела 2*